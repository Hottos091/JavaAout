

-- Database Section
-- ________________

create database test4;
use test4;


-- Tables Section
-- _____________

create table Commande (
     code int not null auto_increment,
     datetransaction date not null,
     numtelfournisseur varchar(64) not null,
     constraint COMMANDE_PK primary key (code));

create table LigneCommande (
     code int not null,
     ingredientlabel varchar(64) not null,
     quantite int not null,
     constraint LIGNECOMMANDE_PK primary key(code, ingredientlabel));

create table Ingredient (
     ingredientlabel varchar(64) not null,
     quantiteenstock int,
     constraint INGREDIENT_PK primary key (ingredientlabel));

create table Composition (
     ingredientlabel varchar(64) not null,
     recettelabel varchar(64) not null,
     quantitenecessaire int not null,
     constraint COMPOSITION_PK primary key (ingredientlabel, recettelabel));

create table Fournisseur (
     numtel varchar(64) not null,
      nom varchar(64) not null,
     prenom varchar(64) not null,
     email varchar(255) not null,
     numerorue integer not null,
     nomRue varchar(64) not null,
     codepostal int not null,
     localitelabel varchar(64) not null,
     constraint FOURNISSEUR_PK primary key (numtel));

create table Localite (
     codepostal integer not null,
     localitelabel varchar(120) not null,
     constraint LOCALITE_PK primary key (codepostal, localitelabel));

create table Recette (
     recettelabel varchar(64) not null,
     tempspreparation integer not null,
     nbpersonnes integer not null,
     constraint RECETTE_PK primary key (recettelabel));

create table EtapeRecette (
     etape_id int auto_increment,
     numeroetape integer not null,
     descriptionetape varchar (255) not null,
     recette_label varchar(64),
     constraint ETAPERECETTE_PK primary key(etape_id));

create table OrdrePreparation (
     code integer not null auto_increment,
     ordrerecettelabel varchar(64) not null,
     matriculecuisinier int not null,
     prixportion double not null,
     dateproduction date not null,
     dateperemption date not null,
     datevente date not null,
     nombreportions integer not null,
     commentairechefcuisinier varchar(255),
     commentairecuisinier varchar(255),
     esturgent boolean not null,
     constraint ORDREPREPARATION_PK primary key (code, ordrerecettelabel));

create table Cuisinier (
     matricule int not null,
     nom varchar(64) not null,
     prenom varchar(64) not null,
     chef_id int,
     constraint CUISINIER_PK primary key (matricule));


-- Constraints Section
-- ___________________

-- Not implemented
-- alter table Commande add constraint COMMANDE_PK_CHK
--     check(exists(select * from Achat
--                  where Achat.Code = Code));

alter table Commande add constraint COMMANDE_FOURNISSEUR_FK
     foreign key (numtelfournisseur)
     references Fournisseur (numtel);

alter table OrdrePreparation add constraint ORDREPREPARATION_RECETTE_FK
     foreign key (ordrerecettelabel)
     references Recette (recettelabel);

alter table OrdrePreparation add constraint ORDREPREPARATION_CUISINIER_FK
     foreign key (matriculecuisinier)
     references Cuisinier (matricule);

alter table Fournisseur add constraint FOURNISSEUR_LOCALITE_FK
     foreign key (codepostal, localitelabel)
     references Localite (codepostal, localitelabel);


-- Not implemented
-- alter table Recette add constraint RECETTE_PK_CHK
--     check(exists(select * from Composition
--                  where Composition.RecetteLabel = RecetteLabel));

alter table LigneCommande add constraint LIGNECOMMANDE_INGREDIENT_FK
     foreign key (ingredientlabel)
     references Ingredient (ingredientlabel);

alter table LigneCommande add constraint LIGNECOMMANDE_COMMANDE_FK
     foreign key (code)
     references Commande (code);

alter table Composition add constraint COMPOSITION_RECETTE_FK
     foreign key (recettelabel)
     references Recette (recettelabel);

alter table Composition add constraint COMPOSITION_INGREDIENT_FK
     foreign key (ingredientlabel)
     references Ingredient (ingredientlabel);

alter table EtapeRecette add constraint ETAPERECETTE_RECETTE_FK
     foreign key (recette_label)
    references Recette (recettelabel);

-- Index Section
-- _____________

create unique index COMMANDE_PK_IND
     on Commande (code);

create index COMMANDE_FOURNISSEUR_FK_IND
     on Commande (numtelfournisseur);

create unique index INGREDIENT_PK_IND
     on Ingredient (ingredientlabel);

create unique index ORDREPREPARATION_PK_IND
     on OrdrePreparation (code);

create unique index FOURNISSEUR_PK_IND
     on Fournisseur (numtel);

create index FOURNISSEUR_LOCALITE_FK_IND
     on Fournisseur (codepostal, localitelabel);

create unique index LOCALITE_PK_IND
     on Localite (codepostal, localitelabel);

create unique index RECETTE_PK_IND
     on Recette (recettelabel);

create unique index LIGNECOMMANDE_PK_IND
     on LigneCommande (ingredientlabel, code);

create index LIGNECOMMANDE_COMMANDE_FK_IND
     on LigneCommande (code);

create unique index COMPOSITION_PK_IND
     on Composition (recettelabel, ingredientlabel);

create index COMPOSITION_INGREDIENT_FK_IND
     on Composition (ingredientlabel);

create unique index CUISINIER_PK_IND
     on Cuisinier (matricule);

create index PREPARATION_FK_IND
     on OrdrePreparation (matriculecuisinier);

create index CREATION_FK_IND
     on OrdrePreparation (ordrerecettelabel);



     ######QUERIES

##Recette
insert into recette values ("Dorade au four", 35, 4);
insert into recette values ("Pâtes Carbonara", 30, 2);


##Cuisinier
insert into cuisinier values(001, "Seb", "Pat", null); #chef

insert into cuisinier values (002, "Asap", "Rocky", 001);

insert into cuisinier values(003, "Spahyd", "Erman", 001);


##etaperecette

insert into etaperecette values(1, 1, "Préchauffez le four à 180°C", "Dorade au four");

insert into etaperecette values(2, 2, "Rincez le poisson", "Dorade au four");

insert into etaperecette values(3, 3, "Epluchez l\'oignon et émincez le finement. Déposez le dans le fond d'un plat à four", "Dorade au four");

insert into etaperecette values(4, 4, "Déposez les dorades par dessus", "Dorade au four");

insert into etaperecette values(5, 5, "Disposez dans les dorades l\'ail haché, les herbes de provence ou le thym et les feuilles de laurier, puis garnissez les également de tranches de citron", "Dorade au four");

insert into etaperecette values(6, 6, "Salez et poivrez", "Dorade au four");

insert into etaperecette values(7, 7, "Arrosez d'un filet d'huile d'olive", "Dorade au four");

insert into etaperecette values(8, 8, "Déposez un fond d'eau dans le plat à four", "Dorade au four");

insert into etaperecette values(9, 9, "Enfournez 30 minutes", "Dorade au four");


insert into etaperecette values(10, 1, "Cuire les pâtes dans un grand volume d'eau bouillante salée.", "Pâtes Carbonara");

insert into etaperecette values(11, 2, "Pendant ce temps, faire dorer les lardons dans une poêle à sec.", "Pâtes Carbonara");

insert into etaperecette values(12, 3, "Lorsqu'ils sont dorés, ajouter la crème et laisser mijoter durant 10 minutes.", "Pâtes Carbonara");

insert into etaperecette values(13, 4, "Egoutter les pâtes, les verser dans la sauce, ajouter l'oeuf battu, mélanger et servir saupoudrer de fromage.", "Pâtes Carbonara");

##ordrepreparation
insert into ordrepreparation values (1, "Dorade au four", 002, 7.5, "2019-07-25", "2019-08-25", "2019-07-26", 40, "", "", true);


##localite
insert into localite values (6890, "Kelkpar");


##fournisseur
insert into fournisseur values ("0477265478", "Bush", "Buisson", "bushbuisson@gmail.com", 47, "Rue de la Forêt", 6890, "Kelkpar");

##Composition

insert into Composition values
('Pâtes', 'Pâtes Carbonara', 350),
('Lardon', 'Pâtes Carbonara', 90),
('Oeuf', 'Pâtes Carbonara', 1),
('Crème fraîche', 'Pâtes Carbonara', 15),
('Gruyère râpé', 'Pâtes Carbonara', 50),
('Poivre', 'Pâtes Carbonara', 0),
('Sel', 'Pâtes Carbonara', 0);

insert into Composition values
('Dorade', 'Dorade au four', 2),
('Citron', 'Dorade au four', 1),
('Herbes De Provence', 'Dorade au four', 0),
('Laurier', 'Dorade au four', 2),
('Ail', 'Dorade au four', 2),
('Oignon', 'Dorade au four', 1),
('Sel', 'Dorade au four', 0),
('Poivre', 'Dorade au four', 0);





     ######QUERIES POUR JAVA

//trouve les étapes pour une recette
     select numeroetape, descriptionetape
from recette, etaperecette
where etaperecette.recette_label = recette.recettelabel
order by numeroetape;

//Sélectionne les étapes de la recette souhaitée
select numeroetape, descriptionetape
from  etaperecette
where recette_label = "Dorade au four"
order by numeroetape;

select numeroetape, descriptionetape
from recette, etaperecette
where etaperecette.recette_label = "Dorade au four";

//trouve les étapes pour une recette
     select numeroetape, descriptionetape
from recette, etaperecette
where etaperecette.recette_label = recette.recettelabel
order by numeroetape;

//Sélectionne les étapes de la recette souhaitée
select descriptionetape
from recette, etaperecette
where etaperecette.recette_label = "Dorade au four";

select numeroetape, descriptionetape
from recette, etaperecette
where etaperecette.recette_label = "Dorade au four";

//Trouve les lignes de commande pour une commande
select lc.ingredientlabel, lc.quantite, c.code
from lignecommande lc, commande c
where lc.code = c.code;

//Sélectionner la dernière ligne d'une table
SELECT code
FROM commande
ORDER BY code DESC
LIMIT 1;

//Sélectionne les ingrédients d'une recette donnée entre deux dates
SELECT o.dateproduction, r.recettelabel, i.ingredientlabel, c.quantitenecessaire
FROM Composition c, Recette r, OrdrePreparation o, Ingredient i
WHERE c.recettelabel = r.recettelabel
AND o.ordrerecettelabel = c.recettelabel
AND i.ingredientlabel = c.ingredientlabel
AND o.dateproduction BETWEEN "2019-08-08" AND "2019-08-20"
ORDER BY o.dateproduction, r.recettelabel;